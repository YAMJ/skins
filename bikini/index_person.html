<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>YAMJ v3 index person</title>
        <script src="js/jQuery.js"></script>
        <!-- Used for the JSON parsing -->
        <script src="js/pure.js"></script>
		<!-- Used for skin language setting -->
		<script src="js/lang.js"></script>
		<!-- Used for template -->
		<script src="js/template.js"></script>		
        <script src="js/jPages.js"></script>
		<script src="js/library2.js"></script>
		<script src="js/my_remote.js"></script>
        <link rel="stylesheet" type="text/css" href="css/yamj-style.css">
        <!-- Used for the paging of the index -->
        <link rel="stylesheet" href="css/jPages.css">
        <!-- Used for the fancy animations -->
        <link rel="stylesheet" href="css/animate.css">
		<!-- used for iscroll special -->
		<script type="text/javascript" src="js/iscroll.js"></script>
    </head>
    <body onload="getIndexData();">
        <script type="text/javascript">

//***************************************************************************************
        var perPageValue = 48;
        var jsondata = null;
		var Prefered_PageValue = "index_all";
		var menuleft_toggle = 0;
		var max_count = 2500;
		var temp_nextcurrent_count = -1;
		var current_count = -1; 
		var temp_current = -1;
		var current_count_for_refresh = -1;
		var located_id = 0;
		// get the prefered_page
		if (localStorage.getItem("prefered_page"))
			{Prefered_PageValue = localStorage.getItem("prefered_page");}
			else {localStorage.setItem("prefered_page", Prefered_PageValue);}
		if (localStorage.getItem("nextcurrent_count"))
			{current_count = localStorage.getItem("nextcurrent_count");}	
		// set a default  if 1rst time and set to the type previously selected if available 
		var index_type = "movie,series";
		if (localStorage.getItem("indextype"))
			{index_type = localStorage.getItem("indextype");}
		// get the search method and reset to default for the next time 
		var index_method = "START";
		if (localStorage.getItem("search_method"))
			{index_method = localStorage.getItem("search_method");
			localStorage.setItem("search_method", "START");}
		var direction = "ASC";
			if (window.localStorage.getItem("direction"))
				{direction = window.localStorage.getItem("direction");}
				else {window.localStorage.setItem("direction", direction);}		
		// init search to blank 
		var search_selection = "";
		window.localStorage.setItem("categorytype", "person");
		var _index_url = "wall"
			if (window.localStorage.getItem('display_type') == "wall")
			{_index_url = "index.html";} else {_index_url = "index_list2.html";}
        // This is the directive used by pure to transform the JSON data into HTML
        // span.Title is a simple substitution of the title
        // img.Poster@src replaces the "src" attribute of the img.Poster
		var COUNT_HEADER = {
                'span.ReturnCount': function(arg) {	
					// as IE doesn't work with more than 2500 item, need to split the request with package of 2500 people
					// to display the real range of people, there is several goodies and temp value 
					// current_cout need to be stored to know what to display before to store and get the next range of people 
					// current_pos is the variable where is stored the absolute position in the totalcount of selected people 
					console.log("current_count value before store_count: "+ current_count);
					temp_current = current_count; 
					current_count_for_refresh = current_count;
					if (temp_current == -1) {temp_current = 1;}
					store_count (arg.context.count, arg.context.totalCount);
					if (temp_current == 1 && current_count == -1)
						{display_count =  arg.context.count+' '+window.localStorage.getItem("results_text")+' /' +arg.context.totalCount;}
						else {
							display_count = window.localStorage.getItem("results_text")+' '+ temp_current +'-'+current_pos+'/' +arg.context.totalCount;
							}
					 console.log("current_count value after store_count: "+ current_count);
					return display_count;
					}
            };	
        var LIST_DIR = {
            "div.person_block": {
                "result<-results": {
                    "span.person_name": function(arg) {
					//	check_duplicated (arg.item.id, arg.item.name);
						return arg.item.name;
						},
                    "img.person_photo@src": function(arg) {
                        // Check to see if there are posters

						var temp_return = "pictures/dummy_photo.jpg";
                        if (arg.item.artwork) {

					//  assume the new artworksortdir return the last photo stored 
							temp_return =  arg.context.basePhotoUrl + arg.item.artwork[0].filename;
						} else {} 
						
						return temp_return; // now return the result 
                    },
                    "img.person_photo@onclick": function(arg) {
                        return "open_person_popup('" + arg.item.id + "', 'close')";
                    },
					"form.duplicate_person@onclick": function(arg) {
						var temp_name = arg.item.name.replace(/\'/g, "");
						 return "input_duplicated_person ('" + arg.item.id + "', '" + temp_name + "')";
					}
                }
            }
        };
		
		
	
    
        // This function calls the API to get the JSON data.
        // It will then update the HTML with the data and set up the paging
        function getIndexData()
        {

			// fill all value according to language setting - from yamjv3_lang_{lang}.xml
			get_lang();
			get_style();
			get_player();
			get_prefered_page();
			
            var jsonUrl = "/yamj3/api/index/person.json?sortdir="+direction+"&dataitems=artwork&artwork=photo&artworksortdir=DESC";
		
			if (window.localStorage.getItem("search_index"))
				{
					switch (index_method) 
							{
							case 'ANY':
									search_selection = window.localStorage.getItem("search_index");
									selected_index = window.localStorage.getItem("person_label") + " (..." +search_selection.toUpperCase() + "...)";
									search_selection = search_selection + "&field=name&mode=" + index_method+ "&sortby=name";
									break;
							case 'START':
									search_selection = window.localStorage.getItem("search_index");
									selected_index = window.localStorage.getItem("person_label") + " (" +search_selection.toUpperCase() + "...)";
									search_selection = search_selection + "&field=name&mode=" + index_method + "&sortby=name";
									break;
							case 'NAME':
							// tweak to search by name, use field last_name
									search_selection = window.localStorage.getItem("search_index")  ;
									selected_index = window.localStorage.getItem("name_label") + " (? " +search_selection.toUpperCase() + "...)"
									search_selection = search_selection + "&field=last_name&mode=START&sortby=last_name" ;
									break;
							case 'PERSON':
							// tweak to search by person, use field first_name
									search_selection = window.localStorage.getItem("search_index") ;
									selected_index = window.localStorage.getItem("person_label") + " (" +search_selection.toUpperCase() + "...)"
									search_selection = search_selection + "&field=first_name&mode=START&sortby=first_name";
									break;
							}	
					
					jsonUrl = jsonUrl + "&search=" + search_selection;		
					window.localStorage.setItem("search_index", "");	
				}	else {
					selected_index = window.localStorage.getItem("person_label") ;
					// by default sort on name ascending 
					jsonUrl = jsonUrl + "&sortby=name";
				//	+ " (" +window.localStorage.getItem("selection_text")+ ")";
						}
				$('#printsearch').html(selected_index);
				localStorage.setItem("current_jsonUrl", jsonUrl);
			// allow to split the request with several request less than 2500 values 
				jsonUrl = jsonUrl + "&start=" + current_count+"&max=" + max_count; 
				console.log("index_person  URL: " + jsonUrl);			

            $.ajax({
                url: jsonUrl,
                async: false,
                dataType: 'jsonp',
                'success': function(data)
                {
                    jsondata = data;
				//	 outputJson(data); 	
                    updateHtml(data);
                    if (window.localStorage.getItem("Paging") == 'true') { 	
						pageData(perPageValue);}
                }
            });
            return jsondata;
        }

        // Run the pure.js function to render the data into the HTML template
        // div.row_person is the part of the template to apply it too.
        // "row_person" is a CLASS attribute, not the id.
        function updateHtml(yamjdata)
        {	
			$p('.count_return').render(yamjdata, COUNT_HEADER);	
            $p('div.row_person').render(yamjdata, LIST_DIR);
        }
	
		function SetIndexData (search)
		{		
				localStorage.setItem("search_index", search);
			// as we change the search item reset the count to the beginning (-1)
				if (search != '')
					{localStorage.setItem("nextcurrent_count", (-1));}
				window.location.reload();
		
		}
		
		function ChangeIndex_special (indextype)
		{		
				localStorage.setItem("indextype", indextype);
			// as we change page reset the count item for the search item to initial value 
				localStorage.setItem("nextcurrent_count", (-1));
				console.log("ChangeIndex_special: " + indextype);
				window.location.href=_index_url;
		}

		function store_count (returncount, totalcount)
		{
			// to allow the manipulation (addition) of each value , all the value need to be parsed as Integer , because there are string 
			// totalcount is the total count of people with the selected search item 
			// maxcount is maximum of item that is allowed by IE without problem - it is fixed to 2500
			// current_pos is the position of the last item within the current request 
			// returncount is the number of item return in the current request (less that maxcount)
			// nextcurrent_count is the last position of the next request if totalcount isn't rised 
			// current_count is the position of the last request which have been get from localStorage 
			
				totalcount = parseInt(totalcount, 10); 
				max_count = parseInt(max_count, 10);
				current_pos = 0;
				if (totalcount > 2500) 
				{
				returncount = parseInt(returncount, 10); 
				current_count = parseInt(current_count, 10); 
				current_pos = returncount + current_count; 
				temp_nextcurrent_count = totalcount;  // if back_asked asked and richted totalcount store the value to use it in this case 
				if (current_pos >= totalcount)
					{
				// reset the nextcurrent_count and current_count to initial value -1, because the current position is greater than total amont of possible item in the database	
				
				//		temp_nextcurrent_count = totalcount;  // if back_asked asked and richted totalcount store the value to use it in this case 
						nextcurrent_count= -1;
						current_count = -1;} 
						else {
								nextcurrent_count = current_pos;
								current_count = returncount;
								localStorage.setItem("current_count", current_count);
								}
				localStorage.setItem("nextcurrent_count", (nextcurrent_count));
				
				} else {
				// reset the nextcurrent_count to initial value -1, because totalcount is less than 2500 (maxcount)
				localStorage.setItem("nextcurrent_count", (-1));
				}
				console.log("temp_nextcurrent_count: " + temp_nextcurrent_count + " current_count: " + current_count); 
				console.log("store_count current_pos: " + current_pos + " total_count: " + totalcount+" returncount: " + returncount+ " nextcurrent_count:" + localStorage.getItem("nextcurrent_count")+" max_count:" + max_count );
		}
		
		function back_asked ()
		{
		
			// if the last person displayed is beetween 4999 and max skip back need to 2 jumps before ==> -5000
				if (current_pos >= 4999)
				{
					nextcurrent_count = (parseInt(current_pos, 10) - 5000);	
				} else {
			// if the last person displayed is beetween 2499 and 4999 and the 1rst person displayed than 2499 skip back need 1 jump before ==> -2500
					if (current_pos > 2499 && temp_current > 2499)
						{nextcurrent_count = (parseInt(nextcurrent_count, 10) - 2500);}
			// if the last person displayed is exactly 2499 , position the last person to the max and the 1rst at -2500 
						else {
								if (nextcurrent_count == 2499)
									{ nextcurrent_count = temp_nextcurrent_count - 2500;}
			// if the 1rst person displayed is beetween 1 and 2499 reinitialise to the beginning
									else {
										if (temp_current < 2499)
											{nextcurrent_count = -1}
										
										}
						}
				}
			localStorage.setItem("nextcurrent_count", nextcurrent_count);
		}
		function check_duplicated (current_id, current_name) 
		{
			if (localStorage.getItem("name_to_compare")) 
			{
				if (localStorage.getItem("name_to_compare") == current_name) 
					{
						console.log ("duplicated name found for name: " + current_name + " id:" + current_id + " with stored name:" + localStorage.getItem('name_to_compare') + " stored id:" + localStorage.getItem('id_to_compare'));
					}
			} 

			
			localStorage.setItem("name_to_compare", current_name);
			localStorage.setItem("id_to_compare", current_id);
		}
		function input_duplicated_person (duplicate_to_set, name_to_set)
		{
			if (localStorage.getItem("duplicate_id_setted") == 'true')
				{
					if (localStorage.getItem("duplicate_id") == duplicate_to_set) {clean_duplicate(false);}
					else {
					localStorage.setItem("duplicate_doublet", duplicate_to_set);
					console.log("input_duplicated_person duplicate_doublet: " + duplicate_to_set + " with name:" + name_to_set ); 
					localStorage.setItem("duplicate_id_setted", false);
					duplicated_person_call (localStorage.getItem('duplicate_id'), duplicate_to_set, name_to_set );
					}
				}
				else
				{
					localStorage.setItem("duplicate_id", duplicate_to_set);
					console.log("input_duplicated_person duplicate_id: " + duplicate_to_set + " with name:" + name_to_set ); 
					localStorage.setItem("duplicate_id_setted", true);
				}
		}
		function duplicated_person_call (id_to_duplicate, doublet_to_duplicate, duplicated_name)
		{
			console.log("duplicated_person_call with name:" + duplicated_name+ " id=" + id_to_duplicate + " doublet=" + doublet_to_duplicate ); 
			// do the job or clean what is selected after the popup of action deasapeared 
			window.setTimeout(function(){clean_duplicate(true);},5050);
			PopAction('duplicate','person ' + duplicated_name, id_to_duplicate, doublet_to_duplicate);
			
	
		}
		function start_duplicate ()
		{
			myStopFunction('infobox_update');
			console.log("start_duplicate: id=" + localStorage.getItem('duplicate_id') + " doublet=" + localStorage.getItem('duplicate_doublet') ); 
			
			
			var jsonUrl = "/yamj3/api/person/duplicate.json?id="+localStorage.getItem('duplicate_id')+"&doublet="+ localStorage.getItem('duplicate_doublet');
			console.log("index_person start_duplicate URL: " + jsonUrl);			
			$.ajax({
                url: jsonUrl,
                async: false,
                dataType: 'jsonp',
                'success': function(data)
                {
                    jsondata = data;
				//	 outputJson(data); 	
                }
            });
			
			localStorage.setItem("duplicate_id", '');
			localStorage.setItem("duplicate_doublet", '');
			localStorage.setItem("duplicate_id_setted", false);
			
			localStorage.setItem('nextcurrent_count', current_count_for_refresh);
			call_personindex('_self');
		}
		function clean_duplicate (need_refresh)
		{
			console.log("clean_duplicate: id=" + localStorage.getItem('duplicate_id') + " doublet=" + localStorage.getItem('duplicate_doublet') ); 
			localStorage.setItem("duplicate_id", '');
			localStorage.setItem("duplicate_doublet", '');
			localStorage.setItem("duplicate_id_setted", false);
			localStorage.setItem('nextcurrent_count', current_count_for_refresh);
			if (need_refresh) {call_personindex('_self');}
		}
	
//************************ LANGUAGE LOCAL SETTING *********************************************		
		// store all value according to language setting - from yamjv3_lang_{lang}.xml - local setting
		function set_context_lang_value ()
		{
			document.getElementById("return_icon").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('home_label').toLowerCase();
			document.getElementById("next_icon").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('next_remote_label').toLowerCase();
			document.getElementById("prev_icon").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('prev_remote_label').toLowerCase();
			document.getElementById("search_item").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('search_select').toLowerCase();
			document.getElementById("info_config").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('skin_').toLowerCase() + " " + window.localStorage.getItem('info_label').toLowerCase();
			switch (window.localStorage.getItem('prefered_page').toLowerCase())
			{
				case 'certification':
				{
					document.getElementById("li_home_left").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('prefered_comment').toLowerCase() + ": " + window.localStorage.getItem('certification_label').toLowerCase();
				break;
				}
				case 'index_all':
				{
					document.getElementById("li_home_left").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('prefered_comment').toLowerCase() + ": " + window.localStorage.getItem('all_label').toLowerCase();
				break;
				}
				case 'index_movie':
				{
					document.getElementById("li_home_left").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('prefered_comment').toLowerCase() + ": " + window.localStorage.getItem('movie_label').toLowerCase();
				break;
				}
				case 'index_series':
				{
					document.getElementById("li_home_left").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('prefered_comment').toLowerCase() + ": " + window.localStorage.getItem('series_label').toLowerCase();
				break;
				}
				case 'new':
				{
					document.getElementById("li_home_left").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('prefered_comment').toLowerCase() + ": " + window.localStorage.getItem('new_').toLowerCase();
				break;
				}
				case 'person':
				{
					document.getElementById("li_home_left").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('prefered_comment').toLowerCase() + ": " + window.localStorage.getItem('person_label').toLowerCase();
				break;
				}
				case 'rating':
				{
					document.getElementById("li_home_left").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('prefered_comment').toLowerCase() + ": " + window.localStorage.getItem('rating_label').toLowerCase();
				break;
				}
				case 'source':
				{
					document.getElementById("li_home_left").attributes.getNamedItem("data-tip2").value=window.localStorage.getItem('prefered_comment').toLowerCase() + ": " + window.localStorage.getItem('source_label').toLowerCase();
				break;
				}
			}
		}
        </script>
		
    <div class="index_header"> 
			<a href="javascript:ouvre_prefered_page()" id="li_home_left" data-tip2="prefered page"></a>
			<a id="info_config" data-tip2="info" href="javascript:ouvre_info_config()" ></a><div class="show_index_videosource"><span id="printsearch"></span></div>
			<div class="count_return">
                   <span class="ReturnCount"></span> 
			</div>
		<!-- just added to set the language value, shouldn't be displayed  -->
			<div class="results" style="visibility: hidden; display:none;">
				<table><tr><td class="Value"></td></tr></table>
			</div>
					
		
		<!--  prev, next 1rst request -->	
		<div id="index_tools_person">
			<div id="search_item" data-tip2="search" onclick="ouvre_popup_search(StyleValue, false)" style="position: absolute; top: -3px; left: 65%;"><img src="pictures/icon/find.png" height="35" width="35"  alt="find" /></div>
			<div id="return_icon" data-tip2="return" onclick="javascript:localStorage.setItem('nextcurrent_count', -1);call_personindex('_self')" ><img src="./pictures/returnbutton.png" alt=return"/></div>
			<div id="next_icon" data-tip2="next" onclick="call_personindex('_self')" ><img src="./pictures/fwd.png" alt="forward"/></div>
			<div id="prev_icon" data-tip2="previous" onclick="back_asked (); call_personindex('_self')" ><img src="./pictures/back.png" alt="back"/></div>
			<button id="infobox_update" onclick="javascript:start_duplicate ()"></button>
		</div>
		<!--Navigation Holder-->
         <div class="holder"></div>
        <!--Data Items Container-->
 	</div>
<!-- add left menu dynamically from a separate file --> 
	<div >
      <object data="include_left_menu.html" type="text/html" id="my_left_menu"></object>
    </div>
	<div id="container" >
            <div id="yRow" class="row_person">
                <div id="yBlock" class="person_block">
                    <img class="person_photo" src="./pictures/dummy_photo.png" alt="photo"><br>
					<form class="duplicate_person" name="duplicate_form" style="position:relative; top: -16vh; left: -2.5vw">
						<input type="checkbox" name="duplicated_name" value="person_id">
					</form>
                    <span class="person_name"></span>
                </div>
                <br />
            </div>
        </div>
	<!-- display config -->
		<div id="target_display" style="visibility: hidden; ">		
			<iframe src="" name="target_frame" resizable="yes" id="target_frame" scrolling="no" frameborder="1" style="overflow:hidden; width:1050px; height:320px;" allowTransparency="true"></iframe>
		</div>	
	<!-- display Movie -->
		<div id="movie_display" style="visibility: hidden; ">
			<iframe src="" name="movie_frame" resizable="yes" id="movie_frame" scrolling="yes" frameborder="1" style="overflow:auto; width:1245px; height:265px;" allowTransparency="true"></iframe>
		</div>	
	<!-- display person -->
		<div id="person_display" style="visibility: hidden; ">	
			<iframe src="" name="person_frame" resizable="yes" id="person_frame" scrolling="yes" frameborder="1" style="overflow:auto; width:1220px; height:701px;" allowTransparency="true"></iframe>
		</div>	
	<!-- display source data from API if needed  -->
        <div id="sourceData"></div>
    </body>
</html>
