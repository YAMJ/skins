<!doctype html>
<html>
    <head>
        <title>YAMJ v3 detail page</title>
        <script src="js/jquery.js"></script>
        <script src="js/pure.js"></script>
        <link rel="stylesheet" type="text/css" href="css/yamj-style.css"/>
        <!--Slider stuff-->
        <link href="slideshow/slideshow.css" rel="stylesheet" type="text/css" />
        <script src="slideshow/slideshow.js" type="text/javascript"></script>
        <script src="slideshow/slideshowFanart.js" type="text/javascript"></script>
        <script type="text/javascript">
			// get the id and the type asked previously, data was stored from index/detail page 
            var id = localStorage.getItem("id");
            var type = localStorage.getItem("type");
			var season = localStorage.getItem("season");
            var jsondata;
			var bullesee = 0;
			// from jsonActorUrl
			var DETAIL_HEADER = {
							'span.header_type': 'result.videoType',
					
							'span.header_title': function (arg) {
								if (type == 'SEASON')
								{
								return arg.context.result.title + ' Season: '+ season;
								} else {
								display_photo();
								return arg.context.result.title;
									}
							},
							'span.header_year': 'result.videoYear',
							'span.header_id': 'result.id'
						};
			// from jsonActorUrl		
            var YAMJ_DIR = {
                'span.plot': function(arg) {
				// check if plot is available 
					if (arg.context.result.plot) {
							return "<text>PLOT</text>" +arg.context.result.plot;
								} else {
							return "<text>NO PLOT AVALAIBLE</text>";
							}
				},
                'span.genres': function(arg)
                {
                    var genres = arg.context.result.genres;
                    var output = "<text>GENRE</text>";
                    var first_genres = true;
					// loop thru the list of genres
                    for (i = 0; i < genres.length; i++) {
                        if (first_genres) {
                            first_genres = false;
                        } else {
                            output += ", ";
                        }
                        output += genres[i].name;
                    }
                    return output;
                },
              
               'img.fanart': {
                    'fanart<-result.artwork.FANART': {
                        '@src': function(arg)
                        {
                            // Check to see if there are fanart
                            if (arg.item) {
                                // Get the first fanart from the list
                                if (arg.item.generatedId === 0) {
                                    return "pictures/dummy_fanart.jpg";
                                }
                                return arg.context.baseArtworkUrl + arg.item.filename;
                            } else {
                                return "pictures/dummy_fanart.jpg";
                            }
                        }

                    }
                },
				
				  'img.poster': {
                    'poster<-result.artwork.POSTER': {
                        '@src': function(arg)
                        {
                            // Check to see if there are posters
                            if (arg.item) {
                                // Get the first poster from the list
                                if (arg.item.generatedId === 0) {
                                    return "pictures/dummy.jpg";
                                }
							// take the opportunity to reset the new season number, in case of next / previous move , only for season type
								if (type == 'SEASON')
								{															
									season =  (arg.item.filename.substr((arg.item.filename.lastIndexOf('season') -4), 3));
									} else {
									season = "";
									}
                                return arg.context.baseArtworkUrl + arg.item.filename;
                            } else {
                                return "pictures/dummy.jpg";
                            }
                        }

                    }
                }, 
				
				'img.banner': {
                    'banner<-result.artwork.BANNER': {
                        '@src': function(arg)
                        {
							if (type == 'SEASON')
								{	
                            // Check to see if there are banner
                            if (arg.item) {
                                // Get the first banner from the list
                                if (arg.item.generatedId === 0) {
                                    return "pictures/dummy_banner.jpg";
                                }
                                return arg.context.baseArtworkUrl + arg.item.filename;
                            } else {
                                return "pictures/dummy_banner.jpg";
                            }
                        }
					}

                    }
                }
            };
		
			// from jsonCrewUrl
			var	ACTOR_NAME = {
					'td' : 
						{	
					// assume there is one 
						"result<-results":{				
						"span.actor-name"		: function(arg)   {
							// check if role is available
								str_bio = "";
								if (arg.item.biography) 
								{
								// replace all ' \n and " by they corresponding value 
								str_bio = arg.item.biography.replace(/\"/g,"\\&quot;").replace(/\'/g,"\\&apos;").replace(/\n/g,"");
								} else {
								str_bio = "no biography available";
								}
								// click on name to display the biography  
								return "<a href=\"#\" onmouseover=\"display('"+ str_bio +"')\" onmouseout=\"nodisplay()\" />"+arg.item.name;
								}
							}
						}
					};		
			// from jsonCrewUrl			
			var	ACTOR_ROLE = {
							'td' : 
							{
								"result<-results":{	
									"span.actor-role"		: function(arg)   {
									// check if role is available
										if (arg.item.role) {
													return arg.item.role;
												} else {
									// adjust to Writer, Director  
													return arg.item.job.substr(0,1)+arg.item.job.substr(1).toLowerCase();
												}	
										}
								}
							}
						};	
						
		
			// from jsonCrewUrl 	
			var LIST_PHOTO = {
             		'span.totalphoto': function(arg) 
					{
						var totalphoto = arg.context.results;
						var outputphoto = "";
									// limit to 11 the photo
							for (i = 0; i < totalphoto.length; i++) 
							{
									// Check to see if there is artwork
								if (totalphoto[i].artwork[0]) 
								{
									// Get the first photo from the list
									
									var photoselect = totalphoto[i].artwork[0];
									if (photoselect.generatedId == 0) 
									{
										outputphoto +="<img class=\"photo"+i+"\" src=\"pictures/dummy_photo.jpg\" ></img>";
									} else {
										outputphoto +="<img class=\"photo"+i+"\" src=\"" + arg.context.basePhotoUrl + photoselect.filename + "\" ></img>";
										}
								} else {
									outputphoto +="<img class=\"photo"+i+"\" src=\"pictures/dummy_photo.jpg\" ></img>";
								}
							}
							return outputphoto;
						}
					};
        
				
            function getData()
            {	  if (id > 0)
			// test if id is valid, this is the case if previous movie is selected while on the first one 
					{									
						var jsonUrl = "http://localhost:8888/yamj3/api/video/" + type.toLowerCase() + "/" + id + ".json?dataitems=genre,artwork,plot";
					console.log("URL: " + jsonUrl);
						var jsonCrewUrl = "http://localhost:8888/yamj3/api/person/" + type.toLowerCase() + ".json?id=" + id + "&job=Actor,Director,Writer&dataitems=artwork";
					console.log("URL: " + jsonCrewUrl);
					} else { 
					// if not valid set to the last movie 
							// wrong_id = "Wrong id reset to last, id asked :" +id;
							// outputJson(wrong_data); 
					// possible to reset to 1rst movie
							//set_first_id ();
							set_last_id ();
					var jsonUrl = "http://localhost:8888/yamj3/api/video/" + type.toLowerCase() + "/" + id + ".json?dataitems=genre,artwork,plot";
					console.log("URL: " + jsonUrl);
						var jsonCrewUrl = "http://localhost:8888/yamj3/api/person/" + type.toLowerCase() + ".json?id=" + id + "&job=Actor,Director,Writer";
					console.log("URL: " + jsonCrewUrl);
							}
                
			
                $.ajax({
                    url: jsonUrl,
                    async: false,
                    dataType: 'jsonp',
                    'success': function(data)
                    {
                        jsondata = data;
						// outputJson(data); 
						$p('.template').render(data, YAMJ_DIR);                
						$p('.header').render(data, DETAIL_HEADER);
						
						// add slideshow for fanart
						slideshowFanart();
						// slideshow for poster
                        slideshow();
						// display all crew
						showfanart ();
				}
                });
               

	             $.ajax({
                    url: jsonCrewUrl,
                    async: false,
                    dataType: 'jsonp',
                    'success': function(dataCrew)
                    {
						jsondata = dataCrew;
					//	outputJson(dataCrew);
						
						$p('.table_actor_name').render(dataCrew, ACTOR_NAME);
						$p('.table_actor_role').render(dataCrew, ACTOR_ROLE);
						$p('.table_photo').render(dataCrew, LIST_PHOTO);
			
					}
                });
            }
  
  // ********************* NOW SET VARIOUS FUNCTION **********************************************
  
        // Add the source output to the end of the page
            function outputJson(yamjdata)
            {
                var sourceData = document.getElementById("sourceData");
                sourceData.setAttribute("class", "code");
                sourceData.innerHTML = '<h4>Source data:</h4>';
                sourceData.appendChild(document.createElement('pre')).innerHTML = JSON.stringify(yamjdata, undefined, 4);
            }
			
		// on show fanart hover button show all fanart
		function showfanart() {	
				$('.show_fanart').hover(function() {
					$('.plot').css('visibility', 'hidden');
					$('.genres').css('visibility', 'hidden');
					$('#tableactorrole').css('visibility', 'hidden');
					$('#biographyshow').css('visibility', 'hidden');
					$('#tableactorname').css('visibility', 'hidden');
					$('.table_photo').css('visibility', 'hidden');
					$('.banner').css('visibility', 'hidden');
					$('div#slideshowCtr ').css('visibility', 'hidden');
					$('div#slideshowFanart').css('opacity', '1');
				}, function() {
					$('.plot').css('visibility', 'visible');
					$('.genres').css('visibility', 'visible');			
					if (type == 'SEASON') {
					$('.banner').css('visibility', 'visible');
					} else {
					$('#tableactorrole').css('visibility', 'visible');
					$('#tableactorname').css('visibility', 'visible');
					$('.table_photo').css('visibility', 'visible');
					}
					$('div#slideshowCtr ').css('visibility', 'visible');
					$('div#slideshowFanart').css('opacity', '0.7');
				});
			}
	// next/previous movie/series, need to be revue for a better implementation a real index list
	function change_movie(x)
        {
            localStorage.setItem("type", type);
			if (x == 'next')
			{
			// basic next id 
				localStorage.setItem("id", parseInt(id, 10) + 1);
				console.log("Storing value: " + type + "-" + (parseInt(id, 10) + 1));
				} else {
					if (parseInt(id, 10) > 0)
					{
					// basic previous id 
						localStorage.setItem("id", parseInt(id, 10) - 1);
						console.log("Storing value: " + type + "-" + (parseInt(id, 10) - 1));
						} else {
						// basic previous id if previous and id already the first
						set_last_id();
						}
				}	
            window.location.href="detail.html";
        }
	// set the 1rst id 
	function set_first_id()
		{
			id = 1;
		}
	
	// set to the last movie, need to fetch the last id from API
	function set_last_id()
		{
		// json to fetch the last movie/tv
			var jsonLastUrl = "http://localhost:8888/yamj3/api/index/video.json?type="+ type.toLowerCase() +"&start=-1&max=1&sortby=title&sortdir=DESC";
            console.log("URL: " + jsonLastUrl);
				$.ajax({
                    url: jsonLastUrl,
                    async: false,
                    dataType: 'jsonp',
                    'success': function(lastdata)
                    {						
                        jsonlastdata = lastdata;
		            // outputJson(lastdata); 
					
					//need to set the id 
					 TEST = {
							'span.lastid': function(arg) { 
								setid (arg.context.results[0].id);
								return  arg.context.results[0].id;									
							}
						};
					 $p('.test').render(lastdata, TEST);	  
					}
					});
		}
		
	// set a new id 
		function setid(Newid)
				{     
				id = Newid;
				localStorage.setItem("id", id);
				console.log("Storing value: " + type + "-" + id);
				window.location.href="detail.html";
				}	
	// display biography 		
		function display(string_to_display)
				{						
					document.getElementById('biographyshow').firstChild.nodeValue = string_to_display;	
					document.getElementById('biographyshow').style.visibility="visible";
				}
	// hidden biography 
		function nodisplay()
					{			
						document.getElementById('biographyshow').style.visibility="hidden";
					}
	// display photo for Cast only if type = movie or series 
		function display_photo()
					{			
						document.getElementById('Person').style.visibility="visible";
					}							
        </script>
    </head>
    <body onload="getData();">
	<!-- navigation to index -->

		<div id="logo">
 					
						<a id="home_right" href="./index_series.html">
							<img src="./pictures/yamj-logo_tv.png" width="100px" />
						</a>
						<a id="home_left" href="./index_movie.html">
							<img src="./pictures/yamj-logo_movie.png" width="100px" />
						</a>
	<!-- navigation to next/previous movie which doesn't take care of the selection before in index --> 
	<!-- need to be revue -->
						<input id="previous_movie" type="button" class="button" onclick="change_movie('previous')" value="" />
						<input id="next_movie" type="button" class="button" onclick="change_movie('next')" value="" />		
        </div>
	<!--  header for movie/series name -->
		<div class="header">
			<table>
				<tr>
	
					<td width="850px">
						<span class="header_type"></span>
						<span class="header_title"></span>
						<span class="header_text"> (</span>
						<span class="header_year"></span>
						<span class="header_text">) id:</span>
						<span class="header_id" ></span>
						</td>
				</tr>
			</table>
		</div>
		
	<!--  ALL CREW button -->	
		<div class="show_fanart">
					<td><span >SHOW FANART</span></td>
		</div>
		<div class="test">
					<td><span class="lastid"></span></td>
		</div> 

	<!-- main table for detail page -->
        <div class="template"> 
           <table>
                  <tbody>
                    <tr>    
						<!-- fanart animation, automatic every 10s, if more than one fanart -->
						<td rowspan="10">
                            <div id="slideshowFanart" class="glow">
                                <div id="imgRollFanart">
                                    <img class="fanart" src=""/>
                                </div>
                            </div>
                            <a id="nextFanart">=></a>
                            <a id="prevFanart"><=</a>
                        </td>
						<!-- poster animation, automatic every 3s, if more than one fanart, could be stopped or adjust by button  -->
						<td rowspan="10">
                            <div id="slideshowCtr" class="glow">
                                <div id="imgRoll">
                                    <img class="poster" src=""/>
                                </div>
                            </div>
							<div><img class="banner" src=""/></div>
						<!-- next , previous button -->
                            <a id="next"><img src="./pictures/next.png" /></a>
                            <a id="prev"><img src="./pictures/previous.png" /></a>
                        </td>        
                    </tr> 
			<!-- split table for image and text --> 
			<!-- add class for each object in the detail section of yamj-style.css -->
					<table class="moviedetail">
						<tr>
							<td><span class="genres"></span></td>
						</tr>
						<tr >
							<td ><span class="plot"></span></td>
						</tr>
						
					
					</table>
                </tbody>
            </table> 	
		</div>

		<!-- to display biography info -->
        <div class="biography" id="biographyshow" >
		<!-- left intentionnaly blank -->
		</div>

		<!-- each table_actor_name, table_actor_role, have fixed layout to limit to 11 the actor display --> 
	<div class="Person" id="Person">
	<!-- actor name  -->
		<div class="table_actor_name">
			<table id="tableactorname">	
				<tr>
					<td class="center">
						<span class="actor-name"></span>
					</td>
				</tr>
			</table>
		</div>
		<div class="table_photo">
			<table id="tablephoto">	
				<tr>
					<td class="center">
					 <span class="totalphoto"></span>
					</td>
				</tr>
			</table>
		</div>
		<!-- role or job  -->
		<div class="table_actor_role">
			<table id="tableactorrole">	
				<tr>
					<td class="center">
						<span class="actor-role"></span>
					</td>
				</tr>
			</table>
		</div>
	</div>

		<!-- display source data from API if needed  -->
        <div id="sourceData"></div>
    </body>
</html>